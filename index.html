<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>C.R.I.S â€” Presas Expostas</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --red:#b00000;
  --dark:#050505;
}
body{
  margin:0;
  background:var(--dark);
  color:#eee;
  font-family: monospace;
}
.scanlines{
  pointer-events:none;
  position:fixed;
  width:100%;
  height:100%;
  background:linear-gradient(rgba(255,255,255,.03) 50%, rgba(0,0,0,.05) 50%);
  background-size:100% 3px;
  mix-blend-mode:overlay;
  z-index:99;
}
.blood{
  position:fixed;
  inset:0;
  background:url("https://i.imgur.com/2yYayZk.png") repeat-x;
  opacity:.25;
  pointer-events:none;
  z-index:98;
}
header{
  padding:20px;
  border-bottom:1px solid var(--red);
}
h1{
  color:var(--red);
  animation:glitch 2s infinite;
}
@keyframes glitch{
  0%{text-shadow:2px 0 red}
  20%{text-shadow:-2px 0 cyan}
  40%{text-shadow:2px 2px lime}
  60%{text-shadow:-2px -2px red}
  80%{text-shadow:2px 0 cyan}
  100%{text-shadow:none}
}
.container{padding:20px}
.box{
  border:1px solid #400;
  background:#0a0a0a;
  padding:15px;
  margin-bottom:15px;
  box-shadow:0 0 15px #200;
}
input,textarea,button{
  width:100%;
  padding:8px;
  margin:6px 0;
  background:#0e0e0e;
  color:#fff;
  border:1px solid #500;
}
button{cursor:pointer}
.hidden{display:none}

.dice-area{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.dice{
  width:60px;
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:28px;
  border:2px solid #333;
  background:#111;
}
.success{color:#00ff66;border-color:#00ff66}
.fail{color:#ff3333;border-color:#ff3333}

.attr{
  display:flex;
  justify-content:space-between;
  margin:5px 0;
}
.attr input{width:60px}
</style>
</head>

<body>

<div class="scanlines"></div>
<div class="blood"></div>

<header>
  <h1>C.R.I.S</h1>
  <p>Campaign Registry & Investigation System</p>
</header>

<div class="container">

<!-- LOGIN -->
<div id="loginBox" class="box">
  <h2>Acesso</h2>
  <input id="email" placeholder="Email">
  <input id="senha" type="password" placeholder="Senha (mÃ­n. 6)">
  <button onclick="login()">Entrar</button>
  <button onclick="registrar()">Registrar</button>
  <p id="erro" style="color:#f33"></p>
</div>

<!-- CAMPANHA -->
<div id="campBox" class="box hidden">
  <h2>Senha da Campanha</h2>
  <input id="senhaCamp" placeholder="Senha">
  <button onclick="entrarCampanha()">Entrar</button>
</div>

<div id="campanha" class="hidden">

  <!-- PLAYER -->
  <div id="playerBox" class="box hidden">
    <h2>Ficha do Player</h2>

    <input id="nome" placeholder="Nome do personagem">
    <textarea id="historia" placeholder="HistÃ³ria"></textarea>

    <h3>Atributos</h3>
    <div class="attr">Agilidade <input id="agi" type="number"></div>
    <div class="attr">Carisma <input id="car" type="number"></div>
    <div class="attr">AstÃºcia <input id="ast" type="number"></div>
    <div class="attr">ForÃ§a <input id="forca" type="number"></div>
    <div class="attr">Vigor <input id="vig" type="number"></div>

    <p>Shots: <span id="shots">0</span>/3</p>
    <button onclick="addShot()">Adicionar Shot</button>

    <p>TensÃ£o: <span id="tensao">0</span>/10</p>

    <h3>Dados</h3>
    <input id="pool" type="number" min="1" value="1">
    <button onclick="rolar()">Rolar Dados</button>

    <div class="dice-area" id="diceArea"></div>

    <button onclick="salvar()">Salvar Ficha</button>
  </div>

  <!-- MESTRE -->
  <div id="masterBox" class="box hidden">
    <h2>Escudo do Mestre</h2>
    <div id="players"></div>
  </div>

</div>
</div>

<script>
/* ðŸ”¥ FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyALP0nO2FneTe-qwKwC_mNlD5jzHMaPljo",
  authDomain: "rpg-campanha.firebaseapp.com",
  projectId: "rpg-campanha",
  storageBucket: "rpg-campanha.firebasestorage.app",
  messagingSenderId: "1095737273808",
  appId: "1:1095737273808:web:9ab46ac71ba836825c1dd5"
};
  
const auth = firebase.auth();
const db = firebase.firestore();

const CAMPAIGN_ID = "campanha_principal";
const SENHA_CAMPANHA = "444";

let uid;
let shots = 0;
let tensao = 0;

/* ðŸ” LOGIN CORRIGIDO */
function login(){
  erro.innerText="";
  if(!email.value || !senha.value){
    erro.innerText="Preencha email e senha.";
    return;
  }

  auth.signInWithEmailAndPassword(email.value, senha.value)
    .then(()=>{
      console.log("Login OK");
    })
    .catch(e=>{
      console.error(e);
      erro.innerText = e.message;
    });
}

function registrar(){
  erro.innerText="";
  if(!email.value || !senha.value){
    erro.innerText="Preencha email e senha.";
    return;
  }

  auth.createUserWithEmailAndPassword(email.value, senha.value)
    .then(()=>{
      console.log("Conta criada");
    })
    .catch(e=>{
      console.error(e);
      erro.innerText = e.message;
    });
}

auth.onAuthStateChanged(user=>{
  if(!user) return;
  uid = user.uid;
  loginBox.classList.add("hidden");
  campBox.classList.remove("hidden");
});

/* ðŸŽ­ CAMPANHA */
function entrarCampanha(){
  if(senhaCamp.value !== SENHA_CAMPANHA){
    alert("Senha incorreta");
    return;
  }

  campBox.classList.add("hidden");
  campanha.classList.remove("hidden");

  db.collection("campaigns").doc(CAMPAIGN_ID).get().then(doc=>{
    if(!doc.exists){
      db.collection("campaigns").doc(CAMPAIGN_ID).set({ mestre: uid });
      masterBox.classList.remove("hidden");
      carregarPlayers();
    }else{
      if(doc.data().mestre === uid){
        masterBox.classList.remove("hidden");
        carregarPlayers();
      }else{
        playerBox.classList.remove("hidden");
        carregarFicha();
      }
    }
  });
}

/* ðŸ“„ PLAYER */
function salvar(){
  db.collection("campaigns").doc(CAMPAIGN_ID)
    .collection("players").doc(uid).set({
      nome:nome.value,
      historia:historia.value,
      agi:agi.value, car:car.value, ast:ast.value,
      forca:forca.value, vig:vig.value,
      shots, tensao
    });
}

function carregarFicha(){
  db.collection("campaigns").doc(CAMPAIGN_ID)
    .collection("players").doc(uid).get().then(doc=>{
      if(!doc.exists) return;
      let d = doc.data();
      nome.value=d.nome||"";
      historia.value=d.historia||"";
      agi.value=d.agi||0;
      car.value=d.car||0;
      ast.value=d.ast||0;
      forca.value=d.forca||0;
      vig.value=d.vig||0;
      shots=d.shots||0;
      tensao=d.tensao||0;
      atualizar();
    });
}

/* ðŸŽ¯ SHOTS */
function addShot(){
  shots=(shots+1)%3;
  atualizar();
}

/* ðŸŽ² DADOS */
function rolar(){
  diceArea.innerHTML="";
  let qtd=parseInt(pool.value);
  let falhas=0;

  for(let i=0;i<qtd;i++){
    let d=Math.floor(Math.random()*6)+1;
    let el=document.createElement("div");
    el.className="dice "+(d<=2?"fail":"success");
    el.innerText=d;
    diceArea.appendChild(el);
    if(d<=2) falhas++;
  }
  tensao=Math.min(10,tensao+falhas);
  atualizar();
}

function atualizar(){
  shotsSpan.innerText = shots;
  tensaoSpan.innerText = tensao;
}

/* ðŸ‘‘ MESTRE */
function carregarPlayers(){
  db.collection("campaigns").doc(CAMPAIGN_ID)
    .collection("players").onSnapshot(snap=>{
      players.innerHTML="";
      snap.forEach(d=>{
        let p=document.createElement("div");
        p.className="box";
        p.innerHTML=`<strong>${d.data().nome||"Sem nome"}</strong>
        <br>Shots: ${d.data().shots} | TensÃ£o: ${d.data().tensao}`;
        players.appendChild(p);
      });
    });
}
</script>

</body>
</html>

